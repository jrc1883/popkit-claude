# Code Review Output Standard

This document defines the required output format for code reviews generated by the `pop-code-review` skill.

## Overview

Code review output must be:
- **Actionable**: Each issue includes a fix recommendation
- **Prioritized**: Issues ordered by confidence/severity
- **Filtered**: Only 80+ confidence issues reported
- **Quantified**: Includes quality score

## Output Structure

```markdown
## Code Review: [Feature/PR Name]

**Scope:** [What was reviewed - staged changes, branch diff, commit range]
**Files:** [N files changed, +X/-Y lines]
**Date:** [YYYY-MM-DD]

### Summary
[1-2 sentences on overall quality and key findings]

### Critical Issues (Must Fix)
_Issues with confidence 90+_

#### Issue 1: [Descriptive Title]
- **File**: `path/to/file.ts:line`
- **Confidence**: 95/100
- **Category**: Bug/Correctness | Security | Performance
- **Description**: [Clear explanation of what's wrong]
- **Impact**: [What could happen if not fixed]
- **Fix**:
```language
// Suggested fix code
```

### Important Issues (Should Fix)
_Issues with confidence 80-89_

#### Issue 2: [Descriptive Title]
- **File**: `path/to/file.ts:line`
- **Confidence**: 82/100
- **Category**: Conventions | DRY | Simplicity
- **Description**: [Clear explanation]
- **Fix**: [How to fix it]

### Notes
_Observations below threshold, included for reference_

- [Optional lower-confidence observations]

### Assessment

| Metric | Value |
|--------|-------|
| Quality Score | X/10 |
| Critical Issues | N |
| Important Issues | N |
| Test Coverage | X% (if available) |

**Ready to merge?** Yes / No / With fixes

**Reasoning**: [1-2 sentences explaining the assessment]
```

## Section Requirements

### Header Section

| Field | Required | Description |
|-------|----------|-------------|
| Feature/PR Name | Yes | Descriptive name for what's being reviewed |
| Scope | Yes | What exactly was reviewed |
| Files | Yes | Number of files and line changes |
| Date | Yes | Review date |

### Summary

- Maximum 2 sentences
- Highlight overall code quality
- Mention most significant finding
- Set expectations for issue count

### Issue Format

Each issue MUST include:

| Field | Required | Description |
|-------|----------|-------------|
| File | Yes | Full path with line number |
| Confidence | Yes | Score out of 100 |
| Category | Yes | One of the standard categories |
| Description | Yes | Clear explanation of the problem |
| Impact | Critical only | Consequences of not fixing |
| Fix | Yes | Actionable fix recommendation |

### Categories

Standard issue categories:

| Category | Description | Typical Threshold |
|----------|-------------|-------------------|
| Security | Vulnerabilities, auth issues | 90+ |
| Bug/Correctness | Logic errors, type issues | 85+ |
| Performance | Inefficiencies, resource leaks | 80+ |
| DRY | Code duplication | 80+ |
| Simplicity | Unnecessary complexity | 80+ |
| Conventions | Pattern violations | 75+ |

### Assessment Section

Required metrics:

| Metric | Description |
|--------|-------------|
| Quality Score | 1-10 overall score |
| Critical Issues | Count of 90+ confidence issues |
| Important Issues | Count of 80-89 confidence issues |
| Test Coverage | Percentage if available |

### Merge Readiness

Three possible values:

| Value | Meaning |
|-------|---------|
| Yes | No blocking issues, approve merge |
| No | Critical issues that must be fixed |
| With fixes | Important issues but can merge after |

## Quality Score Guidelines

| Score | Meaning | Criteria |
|-------|---------|----------|
| 10 | Exceptional | No issues, exemplary code |
| 9 | Excellent | Minor suggestions only |
| 8 | Very Good | Few minor issues |
| 7 | Good | Some issues but solid overall |
| 6 | Acceptable | Multiple issues to address |
| 5 | Needs Work | Significant issues |
| 4 | Poor | Many issues, needs revision |
| 3 | Serious Issues | Major problems throughout |
| 2 | Critical | Security or correctness issues |
| 1 | Reject | Fundamental problems |

## Confidence Threshold Enforcement

### Report (80+)

Issues at or above 80 confidence are included in the output:

```markdown
### Critical Issues (Must Fix)
_Issues with confidence 90+_

### Important Issues (Should Fix)
_Issues with confidence 80-89_
```

### Filter (<80)

Issues below 80 confidence are NOT included unless:
1. Security-related (lower threshold allowed)
2. Explicitly requested by user

### Notes Section

Low-confidence observations may be included in Notes:

```markdown
### Notes
_Observations below threshold, included for reference_

- Possible improvement: [description] (confidence: 65)
```

## Example Output

```markdown
## Code Review: User Authentication Module

**Scope:** Branch diff (feature/user-auth vs main)
**Files:** 8 files changed, +342/-45 lines
**Date:** 2025-12-12

### Summary
Solid implementation of JWT-based authentication. One critical security issue with token validation needs immediate attention. Otherwise well-structured with good test coverage.

### Critical Issues (Must Fix)

#### Issue 1: Missing JWT Signature Verification
- **File**: `src/auth/middleware.ts:45`
- **Confidence**: 98/100
- **Category**: Security
- **Description**: JWT tokens are decoded but signature is not verified, allowing forged tokens.
- **Impact**: Attackers can create valid-looking tokens without the secret key.
- **Fix**:
```typescript
// Before
const decoded = jwt.decode(token);

// After
const decoded = jwt.verify(token, process.env.JWT_SECRET);
```

### Important Issues (Should Fix)

#### Issue 2: Duplicate Password Validation Logic
- **File**: `src/auth/validators.ts:23` and `src/auth/register.ts:67`
- **Confidence**: 85/100
- **Category**: DRY
- **Description**: Password validation rules are duplicated in two files.
- **Fix**: Extract to shared utility function in `src/auth/utils/password.ts`

#### Issue 3: Missing Rate Limiting
- **File**: `src/auth/routes.ts:12`
- **Confidence**: 82/100
- **Category**: Security
- **Description**: Login endpoint has no rate limiting, vulnerable to brute force.
- **Fix**: Add rate limiter middleware (e.g., express-rate-limit)

### Notes

- Consider adding refresh token rotation (confidence: 70)
- Password complexity could be configurable (confidence: 65)

### Assessment

| Metric | Value |
|--------|-------|
| Quality Score | 6/10 |
| Critical Issues | 1 |
| Important Issues | 2 |
| Test Coverage | 78% |

**Ready to merge?** With fixes

**Reasoning**: Strong overall implementation, but JWT signature verification is a blocking security issue. After fixing critical issue, the important issues should be addressed before merge.
```

## Parallel Review Consolidation

When running parallel reviews (simplicity, correctness, conventions), consolidate:

1. **Deduplicate**: Same issue found by multiple reviewers → keep highest confidence
2. **Merge related**: Issues on same code block → combine into single issue
3. **Re-rank**: Adjust confidence based on agreement (multiple reviewers = higher confidence)
4. **Filter**: Apply 80+ threshold to final list
